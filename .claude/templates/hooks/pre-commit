#!/usr/bin/env bash

# pre-commit.quality-gate - Git Pre-commit Hook for Quality Gates
#
# Purpose: Runs quality validation on staged markdown files before commit
# Blocks commits that fail quality gate checks
#
# Usage: Automatically runs before git commit
#   To bypass: git commit --no-verify
#
# Exit codes:
#   0 - Quality checks passed, allow commit
#   1 - Quality checks failed, block commit

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get repository root and script directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Path to validation script
VALIDATE_SCRIPT="$REPO_ROOT/scripts/validate-quality.sh"

# ==========================================
# Utility Functions
# ==========================================

print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# ==========================================
# Main Hook Logic
# ==========================================

main() {
    # Check if validation script exists
    if [[ ! -f "$VALIDATE_SCRIPT" ]]; then
        print_warning "Quality validation script not found: $VALIDATE_SCRIPT"
        print_warning "Skipping quality gates..."
        exit 0
    fi

    # Make sure script is executable
    if [[ ! -x "$VALIDATE_SCRIPT" ]]; then
        chmod +x "$VALIDATE_SCRIPT"
    fi

    # Get list of staged markdown files
    local staged_files=()
    while IFS= read -r -d '' file; do
        staged_files+=("$file")
    done < <(git diff --cached --name-only --diff-filter=ACM -z -- '*.md')

    # If no markdown files staged, allow commit
    if [[ ${#staged_files[@]} -eq 0 ]]; then
        exit 0
    fi

    print_header "Running Quality Gates on Staged Files"
    echo "Checking ${#staged_files[@]} staged markdown file(s)..."
    echo ""

    # Run validation on each staged file
    local failed_files=0
    for file in "${staged_files[@]}"; do
        echo -e "${BLUE}▶ Validating: $file${NC}"

        if ! "$VALIDATE_SCRIPT" "$file" 2>&1 | grep -E '(✓|✗|⚠|Document type|Line count|required sections|YAGNI|Overall)'; then
            print_error "Validation failed for: $file"
            ((failed_files++))
        fi
        echo ""
    done

    # Final result
    if [[ $failed_files -gt 0 ]]; then
        print_header "Quality Gates Failed"
        print_error "$failed_files file(s) failed quality checks"
        echo ""
        echo -e "${YELLOW}Quality gates failed. Please fix the issues above before committing.${NC}"
        echo -e "${YELLOW}To bypass quality gates and commit anyway, use:${NC}"
        echo -e "${YELLOW}  git commit --no-verify${NC}"
        echo ""
        exit 1
    else
        print_header "Quality Gates Passed"
        print_success "All staged files passed quality validation"
        exit 0
    fi
}

# Run main function
main "$@"
